# ============================================================================
# FILE: playbooks/provision.yml
# Provision Ubuntu Server with all dependencies
# ============================================================================

- name: Provision Ubuntu Server for Multi-Service Deployment
  hosts: production
  become: yes
  vars_files: 
    - ../config.yaml
  vars:
    deploy_user: "{{ deployment.user }}"
    deploy_user_home: "{{ deployment.user_home }}"
    github_ssh_key: "{{ github.ssh_deploy_key }}"
    postgres_version: "{{ database.postgresql.version }}"
    postgres_password: "{{ database.postgresql.admin_password }}"
    redis_password: "{{ database.redis.password }}"
    certbot_email: "{{ domain.certbot_email }}"
    backup_dir: "{{ backup.directory }}"

  tasks:
    - name: Update apt cache
      apt: 
        update_cache: yes
        cache_valid_time: 3600

    - name: Upgrade all package
      apt: 
        upgrade: dist
        autoremove: yes
        autoclean: yes

    - name: Install essential packages
      apt:
        name:
          - git
          - curl
          - wget
          - build-essential
          - software-properties-common
          - ufw
          - certbot
          - python3-certbot-nginx
          - gnupg
          - lsb-release
          - ca-certificates
          - apt-transport-https
          - acl
        state: present

    - name: Add PostgreSQL repository key
      apt_key:
        url: https://www.postgresql.org/media/keys/ACCC4CF8.asc
        state: present

    - name: Add PostgreSQL repository
      apt_repository:
        repo: "deb http://apt.postgresql.org/pub/repos/apt {{ ansible_distribution_release }}-pgdg main"
        state: present

    - name: Install PostgreSQL
      apt:
        name:
          - "postgresql-{{ postgres_version }}"
          - "postgresql-contrib-{{ postgres_version }}"
          - postgresql-client
          - python3-psycopg2
        state: present
        update_cache: yes
    
    - name: Ensure PostgreSQL is running
      systemd:
        name: postgresql
        state: started
        enabled: yes

    - name: Set PostgreSQL password
      become_user: postgres
      postgresql_user:
        name: "{{ database.postgresql.admin_user }}"
        password: "{{ postgres_password }}"
        encrypted: yes

    - name: Configure PostgreSQL to accept password authentication
      lineinfile:
        path: "/etc/postgresql/{{ postgres_version }}/main/pg_hba.conf"
        regexp: '^local\s+all\s+postgres\s+peer'
        line: 'local   all             postgres                                md5'
        backup: yes
      notify: restart postgresql

    - name: Install Redis
      apt:
        name:
          - redis-server
          - python3-redis
        state: present

    - name: Configure Redis password
      lineinfile:
        path: /etc/redis/redis.conf
        regexp: '^# requirepass'
        line: "requirepass {{ redis_password }}"
        backup: yes
      notify: restart redis

    - name: Ensure Redis is running
      systemd:
        name: redis-server
        state: started
        enabled: yes

    - name: Download Go installer
      get_url:
        url: https://go.dev/dl/go1.24.4.linux-amd64.tar.gz
        dest: /tmp/go.tar.gz

    - name: Remove old Go installation
      file:
        path: /usr/local/go
        state: absent

    - name: Extract Go
      unarchive:
        src: /tmp/go.tar.gz
        dest: /usr/local
        remote_src: yes

    - name: Add Go to PATH
      lineinfile:
        path: /etc/profile.d/go.sh
        line: 'export PATH=$PATH:/usr/local/go/bin'
        create: yes
        mode: '0644'

    - name: Install Node.js repository
      shell: curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
      args:
        creates: /etc/apt/sources.list.d/nodesource.list

    - name: Install Node.js
      apt:
        name: nodejs
        state: present
        update_cache: yes

    - name: Install NGINX
      apt:
        name: nginx
        state: present

    - name: Ensure NGINX is running
      systemd:
        name: nginx
        state: started
        enabled: yes

    - name: Create deployment user
      user:
        name: "{{ deploy_user }}"
        shell: /bin/bash
        home: "{{ deploy_user_home }}"
        create_home: yes
        groups: sudo
        append: yes

    - name: Create .ssh directory
      file:
        path: "{{ deploy_user_home }}/.ssh"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: '0700'
    
    - name: Deploy GitHub SSH key
      copy:
        content: "{{ github_ssh_key }}"
        dest: "{{ deploy_user_home }}/.ssh/id_rsa"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: '0600'

    - name: Add GitHub to known_hosts
      known_hosts:
        name: github.com
        key: "{{ lookup('pipe', 'ssh-keyscan -t rsa github.com') }}"
        path: "{{ deploy_user_home }}/.ssh/known_hosts"
        state: present

    - name: Create apps directory
      file:
        path: "{{ deploy_user_home }}/apps"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: '0755'

    - name: Configure UFW defaults
      ufw:
        direction: "{{ item.direction }}"
        policy: "{{ item.policy }}"
      loop:
        - { direction: 'incoming', policy: 'deny' }
        - { direction: 'outgoing', policy: 'allow' }

    - name: Allow SSH
      ufw:
        rule: allow
        port: '22'
        proto: tcp

    - name: Allow HTTP
      ufw:
        rule: allow
        port: '80'
        proto: tcp

    - name: Allow HTTPS
      ufw:
        rule: allow
        port: '443'
        proto: tcp

    - name: Enable UFW
      ufw:
        state: enabled

    - name: Create backup directory
      file:
        path: "{{ backup_dir }}"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: '0750'

  handlers:
    - name: restart postgresql
      systemd:
        name: postgresql
        state: restarted

    - name: restart redis
      systemd:
        name: redis-server
        state: restarted